<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Madhuram</title>
    <link rel="icon" type="image/png" href="static/MaruthLabsLogo.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        function applyTheme(theme) {
            if (theme === 'dark' || (theme === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        }
        applyTheme(localStorage.getItem('theme') || 'system');
        tailwind.config = { darkMode: 'class' };
        marked.setOptions({ breaks: true, gfm: true });
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; transition: background 0.2s; }
        .chat-scroll::-webkit-scrollbar { width: 4px; }
        .chat-scroll::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.1); border-radius: 10px; }
        .dark .chat-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); }
        .sidebar-transition { transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .hidden { display: none !important; }
        
        /* Markdown List Styling */
        .prose strong { font-weight: 700; color: inherit; }
        .prose ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 1rem; }
        .prose ol { list-style-type: decimal; padding-left: 1.5rem; margin-bottom: 1rem; }
        .prose li { margin-bottom: 0.5rem; }
        .prose p { margin-bottom: 0.75rem; }
        .prose p:last-child { margin-bottom: 0; }
    </style>
</head>
<body class="bg-white dark:bg-[#0a0a0a] h-screen flex flex-col overflow-hidden text-gray-900 dark:text-gray-100">

    <nav class="bg-white dark:bg-[#111] border-b dark:border-neutral-800 px-4 py-3 flex justify-between items-center z-50 shadow-sm">
        <div class="flex items-center gap-3">
            <button onclick="toggleSidebar()" class="p-2 hover:bg-gray-100 dark:hover:bg-neutral-800 rounded-lg transition">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
            </button>
            <img src="static/MaruthLabsLogo.png" class="w-8 h-8 object-contain">
            <h1 class="font-bold text-lg tracking-tight">Madhuram</h1>
        </div>
        
        <div class="flex items-center gap-3">
            <div class="flex bg-gray-100 dark:bg-neutral-800 p-1 rounded-xl text-[10px] font-bold">
                <button onclick="setTheme('light')" class="px-2 py-1 rounded-lg hover:bg-white dark:hover:bg-neutral-700 uppercase">Light</button>
                <button onclick="setTheme('dark')" class="px-2 py-1 rounded-lg hover:bg-white dark:hover:bg-neutral-700 uppercase">Dark</button>
            </div>
            <div id="auth-wrapper"><div class="g_id_signin" data-type="standard"></div></div>
            <div id="user-profile" class="hidden flex items-center gap-3 pl-3 border-l dark:border-neutral-800">
                <img id="user-pic" src="" class="w-8 h-8 rounded-full border dark:border-neutral-700 shadow-sm">
                <button onclick="logout()" class="text-[10px] text-red-500 font-bold uppercase hover:underline">Logout</button>
            </div>
        </div>
    </nav>

    <div class="flex-1 flex overflow-hidden">
        <aside id="sidebar" class="w-72 bg-gray-50 dark:bg-[#0f0f0f] border-r dark:border-neutral-800 flex flex-col sidebar-transition overflow-hidden">
            <div class="p-4">
                <button onclick="newChat()" class="w-full h-12 flex items-center justify-center gap-3 bg-black dark:bg-white text-white dark:text-black rounded-xl font-bold shadow-lg hover:opacity-90 transition active:scale-95 whitespace-nowrap overflow-hidden">
                    <span class="text-xl">+</span>
                    <span class="sidebar-text">New Chat</span>
                </button>
            </div>
            <div id="history-list" class="flex-1 overflow-y-auto p-3 space-y-2 chat-scroll"></div>
        </aside>

        <main class="flex-1 flex flex-col relative bg-white dark:bg-[#0a0a0a]">
            <div id="lock-screen" class="absolute inset-0 bg-white/95 dark:bg-black/95 z-40 flex flex-col items-center justify-center">
                <div id="g_id_onload" data-client_id="541473878802-b5kub5es0ojipdjei1j6kl75o9a7jk0v.apps.googleusercontent.com" data-callback="handleAuth" data-auto_prompt="false"></div>
                <div class="text-center p-8"><h2 class="text-2xl font-bold mb-2">Sign in to start</h2></div>
            </div>

            <div id="chat-window" class="flex-1 overflow-y-auto p-4 md:p-10 space-y-8 chat-scroll">
                <div id="welcome-screen" class="max-w-2xl mx-auto pt-20 text-center">
                    <h3 class="text-xl font-bold mb-8">How can I help you today?</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <button onclick="fillExample('Explain why the sky is blue')" class="p-5 text-left border dark:border-neutral-800 rounded-2xl hover:bg-gray-50 dark:hover:bg-neutral-900 transition flex flex-col gap-1 group">
                            <span class="text-sm font-bold group-hover:text-blue-500 transition-colors">Explain why the sky is blue</span>
                            <span class="text-xs text-gray-500 dark:text-neutral-400 font-medium leading-relaxed">Dive into the physics of light scattering and the Earth's atmosphere.</span>
                        </button>

                        <button onclick="fillExample('Suggest 3 healthy breakfast ideas')" class="p-5 text-left border dark:border-neutral-800 rounded-2xl hover:bg-gray-50 dark:hover:bg-neutral-900 transition flex flex-col gap-1 group">
                            <span class="text-sm font-bold group-hover:text-green-500 transition-colors">Healthy breakfast ideas</span>
                            <span class="text-xs text-gray-500 dark:text-neutral-400 font-medium leading-relaxed">Get quick and nutritious recipes to start your day with energy.</span>
                        </button>
                    </div>
    
                    <p class="text-[11px] text-gray-400 dark:text-neutral-500 mt-6 font-medium tracking-wide">
                        Select a prompt above or type your own message below to begin.
                    </p>
                </div>
                <div id="messages-container" class="space-y-8"></div>
            </div>

            <div class="p-4 md:p-10 pt-0">
                <div class="max-w-4xl mx-auto flex flex-col items-center">
                    <div class="w-full flex gap-3 items-end bg-gray-50 dark:bg-neutral-900 p-3 border dark:border-neutral-800 rounded-[28px] focus-within:ring-2 ring-black dark:ring-white transition shadow-sm">
                        <textarea id="query" rows="1" class="flex-1 bg-transparent p-2 outline-none text-sm resize-none" placeholder="Type a message..." onkeydown="if(event.key==='Enter' && !event.shiftKey) { event.preventDefault(); send(); }"></textarea>
                        
                        <button id="send-btn" onclick="send()" class="bg-black dark:bg-white text-white dark:text-black p-3 rounded-2xl shadow-lg active:scale-90 transition">
                            <svg id="send-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 10l7-7m0 0l7 7m-7-7v18"></path></svg>
                            <svg id="stop-icon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 24 24"><rect width="14" height="14" x="5" y="5" rx="2" /></svg>
                        </button>
                    </div>
                    <p class="text-[10px] text-gray-400 mt-3 font-medium">Madhuram is AI and can make mistakes.</p>
                </div>
            </div>
        </main>
    </div>

    <script>
        const API_BASE = "https://chat.maruthlabs.com";
        let currentThreadId = null, lastUserMessage = "", abortController = null, isGenerating = false;

        function setTheme(m) { localStorage.setItem('theme', m); location.reload(); }
        function logout() { localStorage.clear(); location.reload(); }
        
        function toggleSidebar() { 
            const sb = document.getElementById('sidebar'), texts = document.querySelectorAll('.sidebar-text');
            if (sb.style.width === '64px') {
                sb.style.width = '288px'; texts.forEach(t => t.classList.remove('hidden'));
            } else {
                sb.style.width = '64px'; texts.forEach(t => t.classList.add('hidden'));
            }
        }

        async function handleAuth(response) {
            const res = await fetch(`${API_BASE}/auth/google`, {
                method: "POST", headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ credential: response.credential })
            });
            const data = await res.json();
            localStorage.setItem('session_token', data.access_token);
            localStorage.setItem('user_info', JSON.stringify(data.user));
            location.reload();
        }

        function checkAuth() {
            const token = localStorage.getItem('session_token');
            if (token) {
                document.getElementById('lock-screen').classList.add('hidden');
                document.getElementById('auth-wrapper').classList.add('hidden');
                document.getElementById('user-profile').classList.remove('hidden');
                const user = JSON.parse(localStorage.getItem('user_info'));
                document.getElementById('user-pic').src = user.picture;
                loadHistory();
            }
        }

        async function send(isRedo = false) {
            if (isGenerating) { stopGeneration(); return; }
            const input = document.getElementById('query'), msg = isRedo ? lastUserMessage : input.value.trim();
            if(!msg) return;
            lastUserMessage = msg;
            document.getElementById('welcome-screen').classList.add('hidden');
            if(!isRedo) appendMessage("user", msg);
            input.value = ""; input.style.height = 'auto';

            setGeneratingState(true);
            abortController = new AbortController();

            const container = document.getElementById('messages-container'), wrapper = document.createElement('div');
            wrapper.className = `flex flex-col items-start animate-in fade-in slide-in-from-bottom-2 duration-300`;
            wrapper.innerHTML = `
                <div class="max-w-[85%] bg-gray-50 dark:bg-neutral-900 border dark:border-neutral-800 p-5 rounded-3xl shadow-sm">
                    <p class="text-[9px] font-black opacity-40 mb-1.5 uppercase tracking-widest">Madhuram</p>
                    <div class="text-[15px] leading-relaxed font-medium prose dark:prose-invert max-w-none message-content"></div>
                </div>`;
            container.appendChild(wrapper);
            const contentDiv = wrapper.querySelector('.message-content');

            try {
                const res = await fetch(`${API_BASE}/chat`, {
                    method: 'POST', signal: abortController.signal,
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('session_token')}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: msg, thread_id: currentThreadId, is_redo: isRedo })
                });

                const reader = res.body.getReader(), decoder = new TextDecoder();
                let fullText = "";
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    const lines = decoder.decode(value).split('\n');
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = JSON.parse(line.slice(6));
                            currentThreadId = data.thread_id;
                            fullText += data.token;
                            contentDiv.innerHTML = marked.parse(fullText);
                            document.getElementById('chat-window').scrollTop = document.getElementById('chat-window').scrollHeight;
                        }
                    }
                }
                addActionButtons(wrapper);
                loadHistory();
            } catch (err) {
                if (err.name === 'AbortError') contentDiv.innerHTML += " <span class='text-red-500 italic text-xs'>(Stopped)</span>";
            } finally { setGeneratingState(false); }
        }

        function stopGeneration() { if (abortController) { abortController.abort(); setGeneratingState(false); } }

        function setGeneratingState(state) {
            isGenerating = state;
            const sendIcon = document.getElementById('send-icon'), stopIcon = document.getElementById('stop-icon'), sendBtn = document.getElementById('send-btn');
            if (state) {
                sendIcon.classList.add('hidden'); stopIcon.classList.remove('hidden');
                sendBtn.classList.replace('bg-black', 'bg-red-500'); sendBtn.classList.replace('dark:bg-white', 'dark:bg-red-600');
            } else {
                sendIcon.classList.remove('hidden'); stopIcon.classList.add('hidden');
                sendBtn.classList.replace('bg-red-500', 'bg-black'); sendBtn.classList.replace('dark:bg-red-600', 'dark:bg-white');
            }
        }

        function addActionButtons(wrapper) {
            const controls = document.createElement('div');
            controls.className = "flex gap-4 mt-2 ml-4";
            controls.innerHTML = `<button onclick="copyResponse(this)" class="text-[10px] font-bold text-gray-400 hover:text-gray-900 dark:hover:text-white transition">COPY</button><button onclick="redoResponse()" class="text-[10px] font-bold text-gray-400 hover:text-gray-900 dark:hover:text-white transition">REDO</button>`;
            wrapper.appendChild(controls);
        }

        function appendMessage(role, text) {
            const container = document.getElementById('messages-container'), wrapper = document.createElement('div');
            const isAssistant = role === 'assistant';
            wrapper.className = `flex flex-col ${role === 'user' ? 'items-end' : 'items-start'} animate-in fade-in slide-in-from-bottom-2 duration-300`;
            const user = JSON.parse(localStorage.getItem('user_info') || '{}'), name = role === 'user' ? (user.name || "User") : "Madhuram";
            const bubbleClass = isAssistant ? 'bg-gray-50 dark:bg-neutral-900 border dark:border-neutral-800 shadow-sm' : 'bg-black text-white shadow-md';
            wrapper.innerHTML = `<div class="max-w-[85%] ${bubbleClass} p-5 rounded-3xl shadow-sm"><p class="text-[9px] font-black opacity-40 mb-1.5 uppercase tracking-widest">${name}</p><div class="text-[15px] leading-relaxed font-medium prose dark:prose-invert message-content">${marked.parse(text)}</div></div>`;
            if (isAssistant) addActionButtons(wrapper);
            container.appendChild(wrapper);
            document.getElementById('chat-window').scrollTop = document.getElementById('chat-window').scrollHeight;
        }

        function copyResponse(btn) { 
            const text = btn.closest('.flex-col').querySelector('.message-content').innerText;
            navigator.clipboard.writeText(text); 
            const original = btn.innerText; btn.innerText = "COPIED"; 
            setTimeout(() => btn.innerText = original, 2000); 
        }

        function redoResponse() { const c = document.getElementById('messages-container'); if (c.lastElementChild) c.removeChild(c.lastElementChild); send(true); }
        
        async function loadHistory() {
            const res = await fetch(`${API_BASE}/threads`, { headers: { 'Authorization': `Bearer ${localStorage.getItem('session_token')}` } });
            const data = await res.json(), list = document.getElementById('history-list');
            list.innerHTML = "";
            data.forEach(t => {
                const div = document.createElement('div');
                div.className = `flex justify-between items-center p-3.5 rounded-2xl cursor-pointer group transition ${currentThreadId === t.id ? 'bg-gray-200 dark:bg-neutral-800' : 'hover:bg-gray-100 dark:hover:bg-neutral-900'}`;
                div.innerHTML = `<span class="text-xs font-bold truncate flex-1 sidebar-text" onclick="loadThread('${t.id}')">${t.title || 'Untitled'}</span><button onclick="deleteThread(event, '${t.id}')" class="opacity-0 group-hover:opacity-100 text-gray-400 hover:text-red-500 sidebar-text transition"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>`;
                list.appendChild(div);
            });
        }

        async function deleteThread(e, id) { e.stopPropagation(); if (!confirm("Delete?")) return; await fetch(`${API_BASE}/threads/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${localStorage.getItem('session_token')}` } }); if (currentThreadId === id) newChat(); loadHistory(); }
        async function loadThread(id) { currentThreadId = id; document.getElementById('welcome-screen').classList.add('hidden'); const res = await fetch(`${API_BASE}/threads/${id}`, { headers: { 'Authorization': `Bearer ${localStorage.getItem('session_token')}` } }); const msgs = await res.json(); document.getElementById('messages-container').innerHTML = ""; msgs.forEach(m => appendMessage(m.role, m.content)); loadHistory(); }
        function newChat() { currentThreadId = null; document.getElementById('messages-container').innerHTML = ""; document.getElementById('welcome-screen').classList.remove('hidden'); loadHistory(); }
        function fillExample(t) { document.getElementById('query').value = t; send(); }
        document.getElementById('query').addEventListener('input', function() { this.style.height = 'auto'; this.style.height = (this.scrollHeight) + 'px'; });
        window.onload = checkAuth;
    </script>
</body>

</html>
